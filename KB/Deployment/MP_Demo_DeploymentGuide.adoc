= Step-by-Step Guide to Deploy Evolveum midPoint Live Demo Using K3s


This guide provides step-by-step instructions for deploying the Evolveum midPoint Live Demo using K3s. It presents two distinct deployment paths: a direct deployment using `kubectl` and a GitOps-driven approach using Argo CD.

The guide adapts to multiple Linux distributions and is based on the `devel` branch of the official repository: https://github.com/Evolveum/midpoint-kubernetes.git

NOTE: If you prefer to automate the entire process, you can run it via a https://github.com/jlukanic/Evolveum/blob/main/KB/Deployment/mp_demo-install-linux.sh[prepared Bash script] instead of executing the steps manually. Please ensure that all variables are adjusted to your current environment before the script is deployed.

== Prerequisites

* A clean Linux VM or server (Ubuntu, Debian, Fedora, CentOS, or RHEL)
* Internet access to fetch packages and container images
* `sudo` privileges on the system
* A GitHub account (required for the Argo CD/GitOps method if you plan to fork and customize the repository)

---

== Step 1: Initial System and Kubernetes Setup

These initial steps are required for both deployment methods.

=== Install System Dependencies
Identify your operating system and use the appropriate package manager to install `curl`, `git`, and `openssh-server`.

[cols="1,1,1"]
|===
| OS | Package Manager | Install Command

| Ubuntu / Debian
| `apt`
| `sudo apt-get update && sudo apt-get install -y curl git openssh-server`

| Fedora
| `dnf`
| `sudo dnf update -y && sudo dnf install -y curl git openssh-server`

| CentOS / RHEL
| `yum`
| `sudo yum update -y && sudo yum install -y curl git openssh-server`
|===

=== Install K3s (Lightweight Kubernetes)
Install K3s using the official script. This command also makes the K3s kubeconfig file readable by your user.

[source,bash]
----
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode=644" sh -
----

=== Configure Kubeconfig
Set up the `KUBECONFIG` environment for `kubectl` to connect to your new K3s cluster.

[source,bash]
----
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
----

=== Clone and Configure the midPoint Repository
Clone the repository and update the configuration values for your environment.

[source,bash]
----
# Clone the repository
git clone --branch devel https://github.com/Evolveum/midpoint-kubernetes.git /opt/midpoint-kubernetes

# Navigate to the repository directory
cd /opt/midpoint-kubernetes

# Update configuration values
sed -i "s|ingress_host: .*|ingress_host: demo.example.com|g" midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
sed -i "s|cluster_domain: .*|cluster_domain: cluster.local|g" midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
sed -i "s|ingress_class_name: .*|ingress_class_name: traefik|g" midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
----

NOTE: Adjust `demo.example.com` to your desired hostname.

---

== Step 2: Deploy midPoint

Choose one of the following methods to deploy midPoint.

=== Method A: Deploy Directly with `kubectl`

This is the simplest method to get midPoint running.

. Create a namespace for the demo.
+
[source,bash]
----
kubectl create namespace mp-demo
----
. Deploy midPoint using `kustomize`.
+
[source,bash]
----
kubectl create -k "/opt/midpoint-kubernetes/midpoint-live-demo/kustomize-base" -n "mp-demo"
----

You can now skip to the <<Accessing midPoint>> section.

=== Method B: Deploy with Argo CD (GitOps)

This method uses Argo CD to manage the deployment, which is ideal for a GitOps workflow.

. **Install Argo CD**
+
Create a namespace and install Argo CD into your cluster.
+
[source,bash]
----
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
----

. **(Optional) Push Changes to Your Git Repository**
+
For a true GitOps workflow, you should commit your configuration changes and push them to your own repository fork. Argo CD will then pull from your repository.
+
[source,bash]
----
cd /opt/midpoint-kubernetes
git init
git config user.email "autobot@midpoint.local"
git config user.name "MidPoint Argo Installer"
# Make sure to replace the URL with your own repository
git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git
git add midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
git commit -m "Initialize midPoint deployment with updated options"
git branch -M devel
git push -f origin devel
----

. **Deploy the Argo CD Application**
+
Apply the Argo CD `Application` manifest. This manifest tells Argo CD where your repository is and how to deploy it.
+
IMPORTANT: If you completed the previous step, update the `repoURL` below to point to your own repository fork.
+
[source,yaml]
----
kubectl apply -n argocd -f - <<EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: midpoint
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/Evolveum/midpoint-kubernetes.git
    targetRevision: devel
    path: midpoint-live-demo/kustomize-base
  destination:
    server: https://kubernetes.default.svc
    namespace: mp-demo
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
EOF
----

. **Access the Argo CD UI**
+
You can monitor the deployment progress through the Argo CD web UI.
+
First, get the initial admin password:
+
[source,bash]
----
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
----
+
Next, forward the Argo CD server port to your local machine:
+
[source,bash]
----
kubectl port-forward svc/argocd-server -n argocd 8080:443
----
+
Now, open `https://localhost:8080` in your browser. Log in with the username `admin` and the password you just retrieved.

---

== Step 3: Accessing midPoint

Once the deployment is complete and the Ingress is ready, you can access the midPoint UI.

* **URL:** `https://demo.example.com` (or the hostname you configured)
* **Username:** `administrator`
* **Password:** `IGA4ever`

If your hostname is not publicly resolvable via DNS, you may need to add an entry to your local `/etc/hosts` file:
[source,text]
----
127.0.0.1 demo.example.com
----

---

== Troubleshooting

=== Hard Reset for `kubectl` Deployments
If your direct `kubectl` deployment fails or you want to start over, you can delete and recreate all resources with a single command. This will completely wipe the existing deployment and start fresh.

[source,bash]
----
kubectl delete namespace mp-demo && kubectl create namespace mp-demo && kubectl create -k /opt/midpoint-kubernetes/midpoint-live-demo/kustomize-base
----

=== Pods are Not Starting
Check the status of all pods in the cluster:
[source,bash]
----
kubectl get pods -A
----

To get more details on a specific failing pod:
[source,bash]
----
kubectl describe pod <pod-name> -n <namespace>
----

Check the logs for a specific container:
[source,bash]
----
kubectl logs <pod-name> -c <container-name> -n <namespace>
----

=== Bad Gateway / Firewall Issues
If the deployment appears healthy but you see a "Bad Gateway" error when accessing the midPoint URL, a local firewall might be blocking traffic.
[source,bash]
----
sudo systemctl status firewalld
sudo systemctl stop firewalld
sudo systemctl disable firewalld
----

=== Argo CD Application Sync/Health Errors
1.  Check the Argo CD UI for detailed error messages on the application.
2.  Look for Kubernetes events in the target namespace: `kubectl get events -n mp-demo`.
3.  If the Argo Application is stuck or broken, you can delete and re-apply it:
+
[source,bash]
----
kubectl delete application midpoint -n argocd
# Then re-apply the application manifest from Step 2
----

=== Ingress Not Working
1.  Confirm the K3s Ingress controller (`traefik`) is running: `kubectl get pods -A | grep traefik`.
2.  Ensure your `ingress_host` in the configuration matches your DNS or `/etc/hosts` entry.
3.  Describe the Ingress resource to check for errors: `kubectl describe ingress -n mp-demo`.

---

== Useful Links

* Evolveum midPoint Kubernetes repository: https://github.com/Evolveum/midpoint-kubernetes
* Evolveum midPoint Documentation: https://docs.evolveum.com/
* Argo CD documentation: https://argo-cd.readthedocs.io
* K3s documentation: https://docs.k3s.io
