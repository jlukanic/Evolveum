= Step-by-Step Guide to Deploy Evolveum midPoint Live Demo Using K3s (kubectl create -k) and Argo CD (optional)
:author:
:revdate: 2025-06-28
:toc:
:icons: font
:source-highlighter: highlight.js
:sectnums:

This guide provides step-by-step instructions for deploying the Evolveum midPoint Live Demo using K3s with a GitOps-ready structure. The primary method described uses kubectl create -k for direct deployment. Argo CD is included as an optional alternative for users who prefer declarative continuous delivery and synchronization.

Repository used:
https://github.com/Evolveum/midpoint-kubernetes.git (branch: devel)

NOTE: To automate the process, use the provided script:
https://github.com/jlukanic/Evolveum/blob/main/KB/Deployment/mp_demo-install-linux.sh
Ensure all variables match your environment before execution.

== Prerequisites

Clean Linux VM (Ubuntu/Debian/Fedora/CentOS/RHEL)

Internet access

Sudo privileges

GitHub account (optional but recommended for GitOps)

== Step 1: Detect Your Linux OS and Use the Appropriate Package Manager

[cols="1,1,1"]
|===
| OS | Package Manager | Install Command

| Ubuntu / Debian
| apt
| sudo apt-get update && sudo apt-get install -y curl git openssh-server

| Fedora
| dnf
| sudo dnf update -y && sudo dnf install -y curl git openssh-server

| CentOS / RHEL
| yum
| sudo yum update -y && sudo yum install -y curl git openssh-server
|===

== Step 2: Install K3s

[source,bash]
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode=644" sh -
K3s: https://k3s.io

== Step 3: Configure kubectl

[source,bash]
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
== Step 4: Clone the midPoint Kubernetes Repository

[source,bash]
git clone --branch devel https://github.com/Evolveum/midpoint-kubernetes.git /opt/midpoint-kubernetes
cd /opt/midpoint-kubernetes
== Step 5: Edit Configuration Files

Edit deployment-specific values in options-map.yaml:

[source,bash]
sed -i "s|ingress_host: .|ingress_host: demo.example.com|g" midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
sed -i "s|cluster_domain: .|cluster_domain: cluster.local|g" midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
sed -i "s|ingress_class_name: .*|ingress_class_name: traefik|g" midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
Update demo.example.com to your preferred domain.

== Step 6: Deploy midPoint Using kubectl create -k (Primary Method)

[source,bash]
kubectl create namespace mp-demo
kubectl create -k midpoint-live-demo/kustomize-base/ -n mp-demo
Wait for all pods to start:

[source,bash]
kubectl get pods -n mp-demo -w
== Step 7: (Optional) Use Argo CD Instead

If you prefer to use Argo CD for GitOps-based deployment:

=== 7.1 Install Argo CD

[source,bash]
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
=== 7.2 Push Your Changes (if using your own Git repo)

[source,bash]
cd /opt/midpoint-kubernetes
git init
git config user.email "autobot@midpoint.local"
git config user.name "MidPoint Argo Installer"
git remote add origin https://github.com/YOUR_USERNAME/YOUR_REPO.git
git add midpoint-live-demo/kustomize-base/kustomize-env-config/options-map.yaml
git commit -m "Initialize midPoint deployment"
git branch -M devel
git push -f origin devel
=== 7.3 Deploy with Argo CD

[source,yaml]
kubectl apply -n argocd -f - <<EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
name: midpoint
namespace: argocd
spec:
project: default
source:
repoURL: https://github.com/Evolveum/midpoint-kubernetes.git
targetRevision: devel
path: midpoint-live-demo/kustomize-base
destination:
server: https://kubernetes.default.svc
namespace: mp-demo
syncPolicy:
automated:
prune: true
selfHeal: true
syncOptions:
- CreateNamespace=true
EOF
=== 7.4 Access Argo CD UI

[source,bash]
kubectl port-forward svc/argocd-server -n argocd 8080:443
Login:

Username: admin

Password:
[source,bash]

kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
Browse to: https://localhost:8080

== Step 8: Access midPoint

After Ingress is ready:

https://demo.example.com

Credentials:

Username: administrator

Password: IGA4ever

If DNS fails, add this to /etc/hosts:

Copy
Edit
127.0.0.1 demo.example.com
== Troubleshooting Tips

=== midPoint or Argo CD Pod Is Not Starting

Check pod status:

[source,bash]
kubectl get pods -A
kubectl describe pod <pod-name> -n <namespace>
kubectl logs <pod-name> -n <namespace>
kubectl logs <pod-name> -c <container-name> -n <namespace>
Temporarily disable firewalld (if needed):

[source,bash]
sudo systemctl status firewalld
sudo systemctl stop firewalld
sudo systemctl disable firewalld
=== Argo CD Application Sync/Health Errors

View errors in Argo CD UI

Inspect events:

[source,bash]
kubectl get events -n mp-demo
Recreate application:

[source,bash]
kubectl delete application midpoint -n argocd

Recreate the manifest as needed
=== Ingress Not Working

Check if traefik is running (K3s default):

[source,bash]
kubectl get pods -A | grep traefik
Confirm Ingress object exists:

[source,bash]
kubectl describe ingress -n mp-demo
Ensure domain resolution works (/etc/hosts)

=== PostgreSQL or midPoint Fails to Start

[source,bash]
kubectl logs <midpoint-pod> -n mp-demo
kubectl logs <postgresql-pod> -n mp-demo
Check for:

Empty/incorrect DB credentials

Failed PersistentVolumeClaims

Init container failures

=== Debug Argo CD via CLI

[source,bash]
Optional CLI tool
argocd app list
argocd app get midpoint
== Useful Links

midPoint Kubernetes repo: https://github.com/Evolveum/midpoint-kubernetes

midPoint Docs: https://docs.evolveum.com

Argo CD Docs: https://argo-cd.readthedocs.io

K3s Docs: https://docs.k3s.io

